{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\jaina\\\\OneDrive\\\\Desktop\\\\Sweet-Shop-Mangement-System\\\\sweet-shop-frontend\\\\src\\\\context\\\\AuthContext.tsx\",\n  _s = $RefreshSig$();\n// src/context/AuthContext.tsx\n\nimport React, { createContext, useState, useEffect } from 'react';\nimport api from '../api/index.ts'; // Your configured Axios instance\nimport { useNavigate } from 'react-router-dom';\nimport axios from 'axios'; // Import axios for error handling\n\n// --- Type Definitions ---\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst AuthContext = /*#__PURE__*/createContext(undefined);\n\n// --- Auth Provider Component ---\n\nexport const AuthProvider = ({\n  children\n}) => {\n  _s();\n  const [user, setUser] = useState(null);\n  const [token, setToken] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const navigate = useNavigate();\n\n  // 1. Initial Load: Check localStorage for token\n  useEffect(() => {\n    const storedToken = localStorage.getItem('token');\n    if (storedToken) {\n      setToken(storedToken);\n      fetchUser(storedToken);\n    } else {\n      setLoading(false);\n    }\n  }, []);\n\n  // 2. Fetch User Details based on Token\n  const fetchUser = async authToken => {\n    try {\n      // Set the Authorization header for the request\n      api.defaults.headers.common['Authorization'] = `Bearer ${authToken}`;\n\n      // Corrected to use /users/me endpoint\n      const response = await api.get('/users/me');\n      setUser(response.data);\n      setLoading(false);\n    } catch (error) {\n      console.error('Token validation failed, logging out.', error);\n      clearAuthData();\n      setLoading(false);\n      // Optionally, navigate to login if an active user fails validation\n      if (window.location.pathname !== '/login') {\n        navigate('/login', {\n          replace: true\n        });\n      }\n    }\n  };\n\n  // 3. Clear all auth data\n  const clearAuthData = () => {\n    localStorage.removeItem('token');\n    setToken(null);\n    setUser(null);\n    delete api.defaults.headers.common['Authorization'];\n  };\n\n  // 4. Login function - THE CRUCIAL CHANGE\n  const login = async (email, password, redirectPath = '/') => {\n    // Step 1: Prepare form data for FastAPI's token endpoint\n    const formData = new URLSearchParams();\n    formData.append('username', email);\n    formData.append('password', password);\n    try {\n      // Step 2: Call the /api/token endpoint (sends credentials, gets token)\n      // Note: The correct full URL is /api/token if your Axios instance prefix is just /api\n      const tokenResponse = await api.post('/token', formData.toString(), {\n        headers: {\n          'Content-Type': 'application/x-www-form-urlencoded' // REQUIRED for FastAPI OAuth2\n        }\n      });\n      const authToken = tokenResponse.data.access_token;\n\n      // Step 3: Save the valid token and validate user details\n      localStorage.setItem('token', authToken);\n      setToken(authToken);\n      await fetchUser(authToken); // Validate and fetch user data\n\n      // Step 4: Redirect on success\n      navigate(redirectPath, {\n        replace: true\n      });\n    } catch (err) {\n      // If API call fails (401 from /token), re-throw the error \n      // so the LoginForm can display the message.\n      if (axios.isAxiosError(err) && err.response) {\n        // Throw the error response for the LoginForm to catch\n        throw err.response.data.detail || \"Authentication failed.\";\n      }\n      throw \"An unexpected error occurred during login.\";\n    }\n  };\n\n  // 5. Logout function\n  const logout = () => {\n    clearAuthData();\n    navigate('/login');\n  };\n  const contextValue = {\n    user,\n    token,\n    isAuthenticated: !!token && !!user,\n    login,\n    logout\n  };\n  if (loading) {\n    return /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"text-center mt-5\",\n      children: \"Loading session...\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 127,\n      columnNumber: 16\n    }, this);\n  }\n  return /*#__PURE__*/_jsxDEV(AuthContext.Provider, {\n    value: contextValue,\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 131,\n    columnNumber: 9\n  }, this);\n};\n_s(AuthProvider, \"RxmIdFOZc61GzKaNhH0Of3r4pH4=\", false, function () {\n  return [useNavigate];\n});\n_c = AuthProvider;\nexport { AuthContext };\nvar _c;\n$RefreshReg$(_c, \"AuthProvider\");","map":{"version":3,"names":["React","createContext","useState","useEffect","api","useNavigate","axios","jsxDEV","_jsxDEV","AuthContext","undefined","AuthProvider","children","_s","user","setUser","token","setToken","loading","setLoading","navigate","storedToken","localStorage","getItem","fetchUser","authToken","defaults","headers","common","response","get","data","error","console","clearAuthData","window","location","pathname","replace","removeItem","login","email","password","redirectPath","formData","URLSearchParams","append","tokenResponse","post","toString","access_token","setItem","err","isAxiosError","detail","logout","contextValue","isAuthenticated","className","fileName","_jsxFileName","lineNumber","columnNumber","Provider","value","_c","$RefreshReg$"],"sources":["C:/Users/jaina/OneDrive/Desktop/Sweet-Shop-Mangement-System/sweet-shop-frontend/src/context/AuthContext.tsx"],"sourcesContent":["// src/context/AuthContext.tsx\r\n\r\nimport React, { createContext, useState, useEffect } from 'react';\r\nimport api from '../api/index.ts'; // Your configured Axios instance\r\nimport { useNavigate } from 'react-router-dom';\r\nimport axios from 'axios'; // Import axios for error handling\r\n\r\n// --- Type Definitions ---\r\ninterface User {\r\n    email: string;\r\n    id: number;\r\n    is_admin: boolean;\r\n}\r\n\r\ninterface AuthContextType {\r\n    user: User | null;\r\n    token: string | null;\r\n    isAuthenticated: boolean;\r\n    // UPDATED: login now takes email and password\r\n    login: (email: string, password: string, redirectPath?: string) => Promise<void>; \r\n    logout: () => void;\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\r\n\r\n// --- Auth Provider Component ---\r\n\r\nexport const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {\r\n    const [user, setUser] = useState<User | null>(null);\r\n    const [token, setToken] = useState<string | null>(null);\r\n    const [loading, setLoading] = useState(true);\r\n    const navigate = useNavigate();\r\n\r\n    // 1. Initial Load: Check localStorage for token\r\n    useEffect(() => {\r\n        const storedToken = localStorage.getItem('token');\r\n        if (storedToken) {\r\n            setToken(storedToken);\r\n            fetchUser(storedToken); \r\n        } else {\r\n            setLoading(false);\r\n        }\r\n    }, []);\r\n\r\n    // 2. Fetch User Details based on Token\r\n    const fetchUser = async (authToken: string) => {\r\n        try {\r\n            // Set the Authorization header for the request\r\n            api.defaults.headers.common['Authorization'] = `Bearer ${authToken}`;\r\n            \r\n            // Corrected to use /users/me endpoint\r\n            const response = await api.get<User>('/users/me'); \r\n            \r\n            setUser(response.data);\r\n            setLoading(false);\r\n        } catch (error) {\r\n            console.error('Token validation failed, logging out.', error);\r\n            clearAuthData();\r\n            setLoading(false);\r\n            // Optionally, navigate to login if an active user fails validation\r\n            if (window.location.pathname !== '/login') {\r\n                 navigate('/login', { replace: true });\r\n            }\r\n        }\r\n    };\r\n    \r\n    // 3. Clear all auth data\r\n    const clearAuthData = () => {\r\n        localStorage.removeItem('token');\r\n        setToken(null);\r\n        setUser(null);\r\n        delete api.defaults.headers.common['Authorization'];\r\n    };\r\n\r\n    // 4. Login function - THE CRUCIAL CHANGE\r\n    const login = async (email: string, password: string, redirectPath: string = '/') => {\r\n        // Step 1: Prepare form data for FastAPI's token endpoint\r\n        const formData = new URLSearchParams();\r\n        formData.append('username', email);\r\n        formData.append('password', password);\r\n\r\n        try {\r\n            // Step 2: Call the /api/token endpoint (sends credentials, gets token)\r\n            // Note: The correct full URL is /api/token if your Axios instance prefix is just /api\r\n            const tokenResponse = await api.post('/token', formData.toString(), {\r\n                headers: {\r\n                    'Content-Type': 'application/x-www-form-urlencoded', // REQUIRED for FastAPI OAuth2\r\n                }\r\n            });\r\n            \r\n            const authToken = tokenResponse.data.access_token; \r\n\r\n            // Step 3: Save the valid token and validate user details\r\n            localStorage.setItem('token', authToken);\r\n            setToken(authToken);\r\n            await fetchUser(authToken); // Validate and fetch user data\r\n\r\n            // Step 4: Redirect on success\r\n            navigate(redirectPath, { replace: true });\r\n\r\n        } catch (err) {\r\n            // If API call fails (401 from /token), re-throw the error \r\n            // so the LoginForm can display the message.\r\n            if (axios.isAxiosError(err) && err.response) {\r\n                // Throw the error response for the LoginForm to catch\r\n                throw err.response.data.detail || \"Authentication failed.\";\r\n            }\r\n            throw \"An unexpected error occurred during login.\";\r\n        }\r\n    };\r\n\r\n    // 5. Logout function\r\n    const logout = () => {\r\n        clearAuthData();\r\n        navigate('/login');\r\n    };\r\n\r\n    const contextValue: AuthContextType = {\r\n        user,\r\n        token,\r\n        isAuthenticated: !!token && !!user,\r\n        login,\r\n        logout,\r\n    };\r\n\r\n    if (loading) {\r\n        return <div className=\"text-center mt-5\">Loading session...</div>;\r\n    }\r\n\r\n    return (\r\n        <AuthContext.Provider value={contextValue}>\r\n            {children}\r\n        </AuthContext.Provider>\r\n    );\r\n};\r\n\r\nexport { AuthContext };"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}